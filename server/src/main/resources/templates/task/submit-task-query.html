<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Datenbankspiel â€“ Submit Task</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-light navbar-expand-md py-3">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="/thymeleaf/">
            <span class="bs-icon-sm bs-icon-rounded bs-icon-primary d-flex justify-content-center align-items-center me-2 bs-icon">
                <!-- icon SVG -->
            </span><span>Datenbankspiel</span>
        </a>
        <button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navcol-1">
            <span class="visually-hidden">Toggle navigation</span><span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navcol-1">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/thymeleaf/user/data">PersonalData</a></li>
            </ul>
            <a class="btn btn-primary ms-md-2" role="button" href="/thymeleaf/user/auth">LogOut</a>
        </div>
    </div>
</nav>

<main class="container mt-5 mb-5">
    <form id="submit-task-form">
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <h2 class="text-center mb-4">ğŸ“ Submit SQL Task</h2>

                <div class="mb-3">
                    <label class="form-label fw-bold">ğŸ“Œ Task Title</label>
                    <input class="form-control" type="text" name="title" readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">ğŸ“– Task Description</label>
                    <textarea class="form-control" name="description" rows="4" readonly></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">ğŸ“Š Tables Available (Setup Result)</label>
                    <textarea class="form-control" id="table-schema-display" rows="10" readonly></textarea>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <h3 class="text-center mb-4">ğŸ§  Write Your SQL Query</h3>

                <textarea class="form-control mb-3" id="solution-query" name="solution-query" rows="5" placeholder="SELECT * FROM ..."></textarea>

                <div class="d-flex flex-column flex-md-row gap-3 mb-3">
                    <div class="d-flex gap-2 w-100">

                        <button class="btn btn-info" type="button" data-bs-toggle="offcanvas" data-bs-target="#myHelpPanel">
                            â“ Help
                        </button>

                        <button type="button" class="btn btn-primary w-100" data-sql-action="run-solution">
                            â–¶ï¸ Run Query
                        </button>
                    </div>

                    <div class="d-flex gap-2 w-100">
                        <button type="button" class="btn btn-secondary w-100" id="reset-setup-btn">
                            ğŸ” Reset Setup
                        </button>
                    </div>
                </div>


                <label class="form-label fw-bold">ğŸ“„ Query Output</label>
                <textarea class="form-control" name="solution-query-result" rows="5" readonly></textarea>
            </div>
        </div>

        <div class="text-center">
            <button
                    type="button"
                    class="btn btn-success btn-lg"
                    id="submit-answer"
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    title="Submit your answer for evaluation and score">
                âœ… Submit Your Answer
            </button>
        </div>
    </form>


    <div class="offcanvas offcanvas-end" tabindex="-1" id="myHelpPanel" aria-labelledby="helpPanelLabel">
        <div class="offcanvas-header">
            <h5 id="helpPanelLabel">Need Help?</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <p>
                Welcome to the SQL Task Submission Interface. This page is designed to help you test your SQL skills by completing real SQL tasks that are backed by dynamically generated tables. Here's how everything works:
            </p>

            <p>
                At the top of the page, you'll see the <strong>Task Title</strong> and a detailed <strong>Description</strong> of what the task is asking you to do. Carefully read the description â€” it outlines the objective, the structure of the database, and what kind of result is expected.
            </p>

            <p>
                Below that, in the <strong>"Tables Available (Setup Result)"</strong> section, you'll see a list of tables that were created behind the scenes for this task. These tables are loaded into a local, in-browser SQL engine. Each table is listed with its name and the columns it contains. This helps you understand what data is available to work with, even though you cannot see the actual `CREATE TABLE` or `INSERT` statements directly.
            </p>

            <p>
                Next comes the main interactive area: the <strong>SQL Query Editor</strong>. Here, you're expected to write your SQL query that will return the expected result based on the task instructions. For example, if the task asks you to "List the names of all products priced above $100," you should write something like <code>SELECT name FROM products WHERE price &gt; 100;</code>.
            </p>

            <p>
                Once your query is ready, click <strong>"â–¶ï¸ Run Query"</strong> to execute it. The result will be shown immediately below. This allows you to test your logic and verify your output before submitting.
            </p>

            <p>
                If you ever want to reset the environment to its original state â€” meaning re-run the setup and restore the original tables â€” just click <strong>"ğŸ” Reset Setup"</strong>. This is helpful if your query made unexpected changes or if you just want a clean slate to try again.
            </p>

            <p>
                When you're confident in your answer, click <strong>"âœ… Submit Your Answer"</strong>. Your result will be sent to the server, compared against the expected result, and if it's correct, you'll earn points. If not, you'll be notified and can try again.
            </p>

            <p>
                All of this happens client-side using <code>sql.js</code>, a WebAssembly-powered SQLite engine, so your queries are executed instantly in your browser. The server only gets involved when you hit the Submit button.
            </p>

            <p class="mt-3"><strong>Good luck â€” and remember: think logically, read the schema carefully, and test before submitting!</strong></p>
        </div>

    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://sql.js.org/dist/sql-wasm.js"></script>
<script src="/assets/js/sql-runner.js"></script>

<script>
    let setupQuery = "";
    let taskPoints = 0;

    function parseJwt(token) {
        try {
            const base64 = token.split('.')[1];
            const payload = atob(base64);
            return JSON.parse(payload);
        } catch (e) {
            return null;
        }
    }

    const token = localStorage.getItem("token");
    const decoded = parseJwt(token);
    const playerId = decoded?.userId || decoded?.id || decoded?.sub;
    const taskId = new URLSearchParams(window.location.search).get("id");

    async function loadTaskDetails() {
        try {
            const res = await fetch(`/api/task/query/${taskId}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const task = await res.json();

            document.querySelector("[name='title']").value = task.title;
            document.querySelector("[name='description']").value = task.description;
            taskPoints = task.points;

            setupQuery = task.setupQuery;
            resetDatabase();
            runQuery(setupQuery);
            displayAllTablesData();
        } catch (err) {
            console.error("Failed to load task:", err);
            alert("âŒ Could not load task.");
        }
    }

    function displayAllTablesData() {
        const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';");
        if (!tables.length) {
            document.getElementById("table-schema-display").value = "No tables found.";
            return;
        }

        let output = "";
        for (const [tableName] of tables[0].values) {
            const result = db.exec(`SELECT * FROM ${tableName}`);
            if (!result.length) continue;
            const { columns, values } = result[0];
            output += `ğŸ“„ ${tableName}\n`;
            output += columns.join(" | ") + "\n";
            output += "-".repeat(columns.join(" | ").length) + "\n";
            values.forEach(row => output += row.join(" | ") + "\n");
            output +=
        document.getElementById("table-schema-display").value = output.trim();
    }
    }

    function bindSqlRunButton() {
        document.querySelectorAll("[data-sql-action]").forEach(button => {
            button.addEventListener("click", () => {
                const query = document.querySelector("[name='solution-query']").value;
                const result = runQuery(query);
                document.querySelector("[name='solution-query-result']").value = result;
            });
        });
    }

    document.getElementById("reset-setup-btn").addEventListener("click", () => {
        resetDatabase();
        runQuery(setupQuery);
        displayAllTablesData();
        document.querySelector("[name='solution-query-result']").value = "ğŸ”„ Setup restored.";
    });

    document.getElementById("submit-answer").addEventListener("click", async () => {
        const query = document.querySelector("[name='solution-query-result']").value.trim();
        if (!query) {
            alert("âš ï¸ Please run and check your SQL output before submitting.");
            return;
        }

        const response = await fetch(`/api/task/submit/query/${playerId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({
                taskId: parseInt(taskId),
                queryAnswer: query
            })
        });

        if (response.ok) {
            const result = await response.json();

            if (result) {
                alert(`âœ… Correct Answer! ğŸ‰\nğŸ† Points Awarded: ${taskPoints}`);
                window.location.href = "/thymeleaf/level?id=" + localStorage.getItem("currentLevelId");
            } else {
                alert("âŒ Wrong answer! Try again.");
            }

        } else {
            const errorText = await response.text();
            alert("âš ï¸ Submission failed: " + errorText);
        }

    });

    window.addEventListener("DOMContentLoaded", async () => {
        await initSqlJsDatabase();
        bindSqlRunButton();
        await loadTaskDetails();
    });
</script>
</body>
</html>

