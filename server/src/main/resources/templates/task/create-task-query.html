<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Datenbankspiel â€“ Create Task Query</title>
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/Navbar-Right-Links-icons.css">
    <link rel="stylesheet" href="/assets/css/Responsive-Full-Width-Grid-from-codedrops.css">
</head>
<body>
<nav class="navbar navbar-light navbar-expand-md py-3">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="/thymeleaf/">
            <span class="bs-icon-sm bs-icon-rounded bs-icon-primary d-flex justify-content-center align-items-center me-2 bs-icon">
                <!-- icon SVG -->
            </span><span>Datenbankspiel</span>
        </a>
        <button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navcol-1">
            <span class="visually-hidden">Toggle navigation</span><span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navcol-1">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/thymeleaf/user/data">PersonalData</a></li>
            </ul>
            <a class="btn btn-primary ms-md-2" role="button" href="/thymeleaf/user/auth">LogOut</a>
        </div>
    </div>
</nav>

<form id="task-query-form">
    <div class="container mt-4">
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="text-center mb-4">New Task Query</h2>
                <p>Related to Level Difficuly:</p>
                <select class="form-select" name="levelId" id="level-select" required>
                    <option value="">Loading levels...</option>
                </select>
                <p>Title:</p>
                <input class="form-control" type="text" name="title" required>

                <p>Description, Requirement:</p>
                <textarea class="form-control" name="description" required></textarea>

                <p>Hint:</p>
                <textarea class="form-control" name="hint"></textarea>

                <p>Points:</p>
                <input class="form-control" type="number" name="points" id="points" placeholder="e.g. 100" required min="1">

                <p>Choose Topic:</p>
                <select class="form-select" name="topicId" id="topic-select" required>
                    <option value="">Loading topics...</option>
                </select>

            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h3 class="text-center">Setup Query</h3>
                <textarea class="form-control mb-2" name="setup-query" rows="5" placeholder="CREATE TABLE ..., INSERT INTO ..."></textarea>
                <div class="d-flex gap-2 mb-2">
                    <button type="button" class="btn btn-primary" data-sql-action="run-setup">Run Query</button>
                    <button type="button" class="btn btn-secondary" data-sql-action="reset-db">Reset Database</button>
                </div>
                <p>Result:</p>
                <textarea class="form-control" name="setup-query-result" rows="4" readonly></textarea>
                <div class="mb-3">
                    <label class="form-label fw-bold">ðŸ“Š Tables Available (Setup Result)</label>
                    <textarea class="form-control" id="table-schema-display" rows="10" readonly></textarea>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h3 class="text-center">Solution Query</h3>
                <textarea class="form-control mb-2" name="solution-query" rows="5" placeholder="SELECT ... FROM ... WHERE ..."></textarea>
                <button type="button" class="btn btn-primary mb-2" data-sql-action="run-solution">Run Query</button>
                <p>Result:</p>
                <textarea class="form-control" name="solution-query-result" rows="4" readonly></textarea>
            </div>
        </div>

        <div class="text-center mb-5">
            <button type="button" class="btn btn-success btn-lg" id="submit-task">Confirm and Create New Task</button>
        </div>
    </div>
</form>

<script src="https://sql.js.org/dist/sql-wasm.js"></script>
<script src="/assets/js/sql-runner.js"></script>

<script>
    const difficultyMap = {
        1: "EASY",
        2: "MEDIUM",
        3: "HARD"
    };

    function loadLevels() {
        const levels = [
            { id: 1, label: "Easy" },
            { id: 2, label: "Medium" },
            { id: 3, label: "Hard" }
        ];

        const select = document.getElementById("level-select");
        select.innerHTML = "";
        levels.forEach(level => {
            const option = document.createElement("option");
            option.value = level.id;
            option.textContent = `${level.id} - ${level.label}`;
            select.appendChild(option);
        });
    }

    async function loadTopics() {
        try {
            const response = await fetch("/api/task/all-topics");
            if (!response.ok) throw new Error("Failed to load topics");
            const topics = await response.json();

            const select = document.getElementById("topic-select");
            select.innerHTML = "";
            topics.forEach(topic => {
                const option = document.createElement("option");
                option.value = topic.topicId;
                option.textContent = topic.topicId + " - " + topic.name;
                select.appendChild(option);
            });
        } catch (err) {
            console.error("Error loading topics:", err);
            const select = document.getElementById("topic-select");
            select.innerHTML = "<option value=''>Error loading topics</option>";
        }
    }

    function displayAllTablesData() {
        const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';");
        if (!tables.length) {
            document.getElementById("table-schema-display").value = "No tables found.";
            return;
        }

        let output = "";
        for (const [tableName] of tables[0].values) {
            const result = db.exec(`SELECT * FROM ${tableName}`);
            if (!result.length) continue;
            const { columns, values } = result[0];
            output += `ðŸ“„ ${tableName}\n`;
            output += columns.join(" | ") + "\n";
            output += "-".repeat(columns.join(" | ").length) + "\n";
            values.forEach(row => output += row.join(" | ") + "\n");
            output += "\n";
        }
        document.getElementById("table-schema-display").value = output.trim();
    }

    document.getElementById("submit-task").addEventListener("click", async () => {
        const title = document.querySelector("input[name='title']").value.trim();
        const description = document.querySelector("textarea[name='description']").value.trim();
        const hint = document.querySelector("textarea[name='hint']").value.trim();
        const setupQuery = document.querySelector("textarea[name='setup-query']").value.trim();
        const rightAnswer = document.querySelector("textarea[name='solution-query-result']").value.trim();

        const topicSelect = document.getElementById("topic-select");
        const topicId = topicSelect.value;
        const topicName = topicSelect.selectedOptions[0]?.dataset.name || "";

        const levelId = document.getElementById("level-select").value;
        const difficulty = difficultyMap[levelId];

        const points = parseInt(document.getElementById("points").value, 10);
        const taskType = "TASK_QUERY";
        const finished = false;

        if (!title || !description || !setupQuery || !rightAnswer || !topicId || !levelId) {
            alert("Please fill in all required fields and select topic + level.");
            return;
        }

        const taskData = {
            title,
            description,
            hint,
            setupQuery,
            rightAnswer,
            topicId: Number(topicId),
            topicName,
            levelId: Number(levelId),
            difficulty,
            taskType,
            points,
            finished
        };

        try {
            const response = await fetch("/api/task/create/query", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(taskData)
            });

            if (response.ok) {
                alert("TaskQuery created successfully!");
                document.getElementById("task-query-form").reset();
            } else {
                const error = await response.text();
                alert("Error: " + error);
            }
        } catch (err) {
            alert("Request failed: " + err.message);
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        loadTopics();
        loadLevels();
    });

    document.getElementById("reset-setup-btn").addEventListener("click", () => {
        resetDatabase();
        runQuery(setupQuery);
        displayAllTablesData();
        document.querySelector("[name='solution-query-result']").value = "ðŸ”„ Setup restored.";
    });
</script>




</body>
</html>
